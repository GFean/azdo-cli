# azdo-cli

A friendly, interactive CLI for running Azure DevOps pipelines from your terminal.

## Why azdo-cli?

Azure DevOps pipelines are powerful, but triggering builds from the UI can be slow.
**azdo-cli** helps you:

- Run pipelines directly from the terminal
- Select pipelines and branches interactively
- Prompt for pipeline parameters with sensible defaults
- Work with Azure Repos and external repos (e.g. Bitbucket)

## Requirements

- Node.js 18+ (uses built-in `fetch`)
- Git (used for branch discovery)
- Azure DevOps access
- A Personal Access Token (PAT) with permission to list and run pipelines

## Install

### npm

```bash
npm install --save-dev @gfean/azdo-cli
```

### yarn

```bash
yarn add --dev @gfean/azdo-cli
```

Run via:

```bash
npx azdo --help
# or

yarn azdo --help
```

## Quick start

### 1) Create a `.env`

```env
AZDO_ORG_URL=https://dev.azure.com/your-organization
AZDO_PROJECT=Your Project Name
AZDO_PAT=your_personal_access_token
```

### 2) Initialize

```bash
npx azdo init
# or
yarn azdo init
```

This creates `azdo.config.json` and discovers pipelines.

### 3) Run a build

```bash
npx azdo build
# or
yarn azdo build
```

You’ll be guided through:

- Selecting a pipeline
- Choosing a branch
- Filling in pipeline parameters
- Optionally waiting for completion

## Configuration

### Required environment variables

- `AZDO_ORG_URL` (e.g. `https://dev.azure.com/your-organization`)
- `AZDO_PROJECT` (exact project name)
- `AZDO_PAT` (Personal Access Token)

Environment files are loaded in this order:

1) `.env`
2) `.env.internal` (overrides `.env`)

### azdo.config.json

Generated by `azdo init` and stored in your repo. You can edit it to pin branches
or point to local YAML files for parameter discovery.

Example:

```json
{
  "orgUrl": "https://dev.azure.com/your-organization",
  "project": "Your Project Name",
  "auth": { "patEnv": "AZDO_PAT" },
  "defaults": { "branch": "develop", "pollMs": 7000 },
  "pipelines": {
    "android_staging": { "id": 12, "name": "Android Staging Pipeline" },
    "ios_production": { "id": 15, "name": "iOS Production Pipeline", "branch": "main" },
    "android_self_hosted": {
      "id": 18,
      "name": "Android Self-Hosted Pipeline",
      "path": "pipelines/android-prod.yml"
    }
  }
}
```

Notes:

- `pipelines.<key>.path` points to a local YAML file (optional). If set, it is used to extract parameters.
- `pipelines.<key>.branch` overrides the default branch for that pipeline.

## Commands

### azdo init

Initialize azdo-cli in the current repo.

```bash
npx azdo init
npx azdo init --interactive
npx azdo init --no-write-env
```

Options:

- `--interactive` prompts for values even if env vars exist
- `--no-write-env` skips writing `AZDO_PAT` to `.env`

### azdo build

Run a pipeline defined in `azdo.config.json`.

```bash
npx azdo build
```

Options:

- `-p, --pipeline <pipeline_id|key>` select pipeline by id or config key
- `-b, --branch <name>` override branch
- `--param <key=value>` repeatable parameter overrides
- `--poll <ms>` polling interval (default 7000 ms)
- `--no-prompt` skip interactive prompts (use defaults + flags)
- `--no-wait` trigger and exit immediately

Examples:

```bash
npx azdo build --pipeline android_staging
npx azdo build --no-prompt --versionCode 123 --cleanGradleProject true
npx azdo build --branch develop --param versionName=1.2.3
```

Branch selection (interactive):

- If you don’t pass `--branch` and prompts are enabled, you can:
  - Enter a branch name
  - Select from local git branches (arrow keys)

### azdo run

Trigger a pipeline by ID without using `azdo.config.json`.

```bash
npx azdo run --pipeline <pipeline_id>
```

Options:

- `-p, --pipeline <pipeline_id>` required
- `-b, --branch <name>` branch name
- `--param <key=value>` repeatable parameter overrides
- `--poll <ms>` polling interval (default 7000 ms)
- `--no-wait` trigger and exit immediately

Examples:

```bash
npx azdo run --pipeline <pipeline_id> --branch develop
npx azdo run --pipeline <pipeline_id> --poll 10000 --versionCode 123
npx azdo run --pipeline <pipeline_id> --no-wait --versionCode 123
```

## Parameters & prompts

### Passing parameters by flags

Both `build` and `run` accept:

- `--param key=value` (repeatable)
- Any unknown `--flag` / `--flag=value` / `--flag value`
- `--no-flag` sets a boolean param to `false`

Examples:

```bash
npx azdo build --param versionCode=123 --param cleanGradleProject=true
npx azdo build --versionCode 123 --cleanGradleProject true
npx azdo run --pipeline <pipeline_id> --releaseNotes "hello world"
```

Note: quote values with spaces (e.g. `"hello world"`).

### Parameter prompts and defaults

When YAML contains `parameters`, the CLI prompts you for each parameter and pre-fills defaults.
Press Enter to accept a default.

Supported YAML shapes:

```yaml
parameters:
  - name: versionCode
    type: number
    default: 123
  - name: cleanGradleProject
    type: boolean
    default: true
  - name: track
    type: string
    values: [internal, beta, production]
```

Or:

```yaml
parameters:
  versionCode: 123
  cleanGradleProject: true
```

### YAML discovery order (build)

1) `pipelines.<key>.path` in `azdo.config.json`
2) Azure DevOps pipeline YAML (Azure Repos Git only)
3) Local repo search for `*.yml` / `*.yaml` (best match by pipeline name/key)

If multiple files match, you are prompted to choose one. In `--no-prompt` mode, the best match is used automatically.

## Exit codes

- `0` success
- `1` error or failed pipeline

## Security

- Tokens are only sent to Azure DevOps
- No telemetry
- No background services
